pipeline {
    agent any

    environment {
        KUBE_CONFIG = credentials('leewoojin12')
        HELM_HOME = "${WORKSPACE}/.helm"
        NAMESPACE = 'db-replication'
        RELEASE = 'mysql-replica'
        CHART = 'bitnami/mysql'
    }

    stages {
        stage('Checkout') {
            steps { checkout scm }
        }
        stage('Create Namespace') {
            steps {
                sh "kubectl --kubeconfig=${KUBE_CONFIG} apply -f k8s/namespace.yaml"
            }
        }
        stage('Deploy MySQL Master-Slave via Helm') {
            steps {
                sh "chmod +x k8s/helm-deploy.sh"
                sh "k8s/helm-deploy.sh ${KUBE_CONFIG} ${NAMESPACE} ${RELEASE} ${CHART} k8s/mysql-values.yaml"
            }
        }
        stage('Verify') {
            steps {
                sh "kubectl --kubeconfig=${KUBE_CONFIG} -n ${NAMESPACE} get pods,svc"
            }
        }
    }
}
